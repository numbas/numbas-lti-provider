{% extends "numbas_lti/management/base.html" %}
{% load i18n %}
{% load icon %}
{% load percentage %}
{% load querystring %}

{% block body_class %}{{block.super}} dashboard{% endblock %}

{% block management_header %}
    <h1>{% translate "Dashboard" %}
{% endblock management_header %}

{% block management_content %}
    <section id="availability">
        {% if resource.is_available %}
            <p class="info">{% translate "This resource is currently available to students." %}</p>
        {% else %}
            <p class="warning">{% translate "This resource is not currently available to students." %}</p>
        {% endif %}
    </section>

    {% if resource.attempts.count %}

        <section id="attempts-count">
            <p><strong>{{resource.unbroken_attempts.count}}</strong> {% blocktranslate count counter=resource.unbroken_attempts.count %}attempt{% plural %}attempts{% endblocktranslate %} {% translate "by" %} <strong>{{students.count}}</strong> {% blocktranslate count counter=students.count %}student{% plural %}students{% endblocktranslate %}.</p>
        </section>

        {% if last_report_process %}
        <section id="last-report-status">
            {% if last_report_process.status == 'reporting' %}
                <div class="alert info">
                    <p>{% translate "Scores are currently being reported back to the grade book" %}.</p>
                    <p><a class="button danger" href="{% url_with_lti 'dismiss_report_process' last_report_process.pk %}">{% translate "Cancel" %}</a></p>
                </div>
            {% elif last_report_process.status == 'complete' %}
                <div class="alert success">
                    <p>{% translate "Scores were successfully reported back to the grade book." %}</p>
                    <p><a class="button success small" href="{% url_with_lti 'dismiss_report_process' last_report_process.pk %}">{% translate "Dismiss this message" %}</a></p>
                </div>
            {% elif last_report_process.status == 'error' %}
                <div class="alert danger">
                    <p>{% translate "An error was encountered while reporting scores back to the grade book:" %}</p>
                    <pre>{{last_report_process.response}}</pre>
                    <p>{% translate "Report this error to your VLE's administrator." %}</p>
                    <p><a class="button danger small" href="{% url_with_lti 'dismiss_report_process' last_report_process.pk %}">{% translate "Dismiss this message" %}</a></p>
                </div>
            {% endif %}
        </section>
        {% endif %}

        <section>
            <ul class="list-unstyled actions">
                <li><form method="POST" action="{% url_with_lti 'scores_csv' resource.pk %}">{% csrf_token %}<button type="submit" class="button info">{% icon 'save' %} {% translate "Download scores as CSV" %}</button></form></li>
                {% if not last_report_process %}
                <li>
                    <a class="button warning" href="{% url_with_lti 'report_scores' resource.pk %}">{% icon 'upload' %} {% translate "Report scores back to VLE" %}</a>
                    {% if dismissed_report_process %}
                    <span class="text-warning">{% translate "A report process is being cancelled. Consider waiting until it has finished." %}</span>
                    {% endif %}
                </li>
                {% endif %}
                <li><a href="{% url_with_lti 'student_progress' resource.pk %}">{% icon 'user' %} {% translate "View individual student progress and grant access tokens" %}</a></li>
                <li>
                    <a class="button danger" href="{% url_with_lti 'discount_parts' resource.pk %}">{% icon 'minus-sign' %} {% translate "Discount question parts" %}</a>
                    <span class="help-block">{% translate "You can remark individual attempts on the attempts page." %}</span>
                </li>
                <li>
                    <a class="button info" href="{% url_with_lti 'validate_receipt' resource.pk %}">{% icon 'ok' %} {% translate "Validate a receipt code" %}</a>
                </li>
            </ul>
        </section>

    {% else %}
        <section id="attempts-count">
            <p>{% translate "No students have attempted this exam yet. Information about scores will appear here once a student attempts this exam." %}</p>
        </section>
    {% endif %}

    {% if exam_info %}
    <hr>

    <section id="settings-info">
        {% if exam_info.navigateMode == 'sequence' %}
        <p>{% blocktranslate %}This exam is in <strong>sequential mode</strong>, best for summative assessments.{% endblocktranslate %}</p>
        {% endif %}
        {% if exam_info.navigateMode == 'menu' %}
        <p>{% blocktranslate %}This exam is in <strong>choose from a menu mode</strong>, best for formative material.{% endblocktranslate %}</p>
        {% endif %}

        {% if resource.max_attempts == 0 %}
        <p>{% blocktranslate %}Students are allowed to start as many attempts as they like.{% endblocktranslate %}</p>
        {% else %}
        <p>{% blocktranslate count counter=resource.max_attempts with max_attempts=resource.max_attempts %}Students may make <strong>one</strong> attempt.{% plural %}Students may start <strong>{{max_attempts}}</strong> attempts.{% endblocktranslate %}</p>
        {% endif %}

        <p>{% blocktranslate %}Students will be shown the following information:{% endblocktranslate %}</p>

        <table>
            <thead>
                <tr>
                    <td></td>
                    <th>{% translate "During an attempt" %}</th>
                    <th>{% translate "Immediately after finishing an attempt" %}</th>
                    <th>{% translate "When viewing an attempt in review mode" %}</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>{% translate "Total awarded scores for each attempt" %}</th>
                    {% if resource.show_marks_when == 'always' %}<td class="success">{% translate "Shown" %}</td>{% else %}<td class="danger">{% translate "Not shown" %}</td>{% endif %}
                    {% if resource.show_marks_when == 'always' or resource.show_marks_when == 'complete' %}<td class="success">{% translate "Shown" %}</td>{% else %}<td class="danger">{% translate "Not shown" %}</td>{% endif %}
                    {% if resource.show_marks_when != 'never' %}<td class="success">{% translate "Shown" %}</td>{% else %}<td class="danger">{% translate "Not shown" %}</td>{% endif %}
                </tr>
                <tr>
                    <th>{% translate "Part and question maximum scores" %}</th>
                    {% if exam_info.showTotalMark %}<td class="success">{% translate "Shown" %}</td>{% else %}<td class="danger">{% translate "Not shown" %}</td>{% endif %}
                    {% if exam_info.showTotalMark or exam_info.completionShowResultsPage %}<td class="success">{% translate "Shown" %}</td>{% else %}<td class="danger">{% translate "Not shown" %}</td>{% endif %}
                    {% if exam_info.showTotalMark or exam_info.reviewShowResultsPage %}<td class="success">{% translate "Shown" %}</td>{% else %}<td class="danger">{% translate "Not shown" %}</td>{% endif %}
                </tr>
                <tr>
                    <th>{% translate "Awarded scores" %}</th>
                    {% if exam_info.showActualMark %}<td class="success">{% translate "Shown" %}</td>{% else %}<td class="danger">{% translate "Not shown" %}</td>{% endif %}
                    {% if exam_info.showActualMark or exam_info.completionShowResultsPage %}<td class="success">{% translate "Shown" %}</td>{% else %}<td class="danger">{% translate "Not shown" %}</td>{% endif %}
                    {% if exam_info.showActualMark or exam_info.reviewShowScore %}<td class="success">{% translate "Shown" %}</td>{% else %}<td class="danger">{% translate "Not shown" %}</td>{% endif %}
                </tr>
                <tr>
                    <th>{% translate "Expected answers" %}</th>
                    {% if exam_info.allowRevealAnswer %}<td class="success">{% translate "Available" %}</td>{% else %}<td class="danger">{% translate "Not shown" %}</td>{% endif %}
                    {% if exam_info.completionShowResultsPage and exam_info.reviewShowExpectedAnswer %}<td class="success">{% translate "Shown" %}</td>{% else %}<td class="danger">{% translate "Not shown" %}</td>{% endif %}
                    {% if exam_info.reviewShowResultsPage and exam_info.reviewShowExpectedAnswer %}<td class="success">{% translate "Shown" %}</td>{% else %}<td class="danger">{% translate "Not shown" %}</td>{% endif %}
                </tr>
                <tr>
                    <th>{% translate "Question advice" %}</th>
                    {% if exam_info.allowRevealAnswer %}<td class="success">{% translate "Available" %}</td>{% else %}<td class="danger">{% translate "Not shown" %}</td>{% endif %}
                    {% if exam_info.completionShowResultsPage and exam_info.reviewShowAdvice %}<td class="success">{% translate "Shown" %}</td>{% else %}<td class="danger">{% translate "Not shown" %}</td>{% endif %}
                    {% if exam_info.reviewShowResultsPage and exam_info.reviewShowAdvice %}<td class="success">{% translate "Shown" %}</td>{% else %}<td class="danger">{% translate "Not shown" %}</td>{% endif %}
                </tr>
                <tr>
                    <th>{% translate "Part feedback" %}</th>
                    {% if exam_info.showAnswerState %}<td class="success">{% translate "Shown" %}</td>{% else %}<td class="danger">{% translate "Not shown" %}</td>{% endif %}
                    {% if exam_info.showAnswerState or exam_info.completionShowResultsPage and exam_info.reviewShowFeedback %}<td class="success">{% translate "Shown" %}</td>{% else %}<td class="danger">{% translate "Not shown" %}</td>{% endif %}
                    {% if exam_info.showAnswerState or exam_info.reviewShowResultsPage and exam_info.reviewShowFeedback %}<td class="success">{% translate "Shown" %}</td>{% else %}<td class="danger">{% translate "Not shown" %}</td>{% endif %}
                </tr>
                <tr>
                    <th>{% translate "Print a transcript" %}</th>
                    {% if exam_info.allowPrinting %}<td class="success">{% translate "Allowed" %}</td>{% else %}<td class="danger">{% translate "Not allowed" %}</td>{% endif %}
                    {% if exam_info.allowPrinting %}<td class="success">{% translate "Allowed" %}</td>{% else %}<td class="danger">{% translate "Not allowed" %}</td>{% endif %}
                    {% if exam_info.allowPrinting %}<td class="success">{% translate "Allowed" %}</td>{% else %}<td class="danger">{% translate "Not allowed" %}</td>{% endif %}
                </tr>
            </tbody>
        </table>

        {% if exam_info.startPassword %}
        <p>{% blocktranslate %}Students <strong>must</strong> enter a password to begin this exam.{% endblocktranslate %}</p>
        {% else %}
        <p>{% blocktranslate %}Students <strong>do not</strong> need to enter a password to begin this exam.{% endblocktranslate %}</p>
        {% endif %}

        {% if exam_info.hasPercentPass %}
        <p>{% blocktranslate with threshold=exam_info.percentPass%}There is a pass threshold of <strong>{{threshold}}%</strong>.{% endblocktranslate %}</p>
        {% endif %}

        {% if exam_info.hasTimeLimit %}
        <p>{% blocktranslate with duration=exam_info.duration|floatformat %}There is a time limit of <strong>{{duration}} minutes</strong>.{% endblocktranslate %}</p>
        {% else %}
        <p>{% blocktranslate %}This exam has no time limit.{% endblocktranslate %}</p>
        {% endif %}

        <p>{% blocktranslate %}During an attempt, students:{% endblocktranslate %}</p>
        <ul>
            <li>{% if exam_info.allowRegen %}{% blocktranslate %}<strong>may</strong> regenerate questions.{% endblocktranslate %}{% else %}{% blocktranslate %}<strong>may not</strong> regenerate questions.{% endblocktranslate %}{% endif %}</li>
            <li>{% if exam_info.allowBrowse %}{% blocktranslate %}may move freely between questions.{% endblocktranslate %}{% else %}{% if exam_info.allowReverse %}{% blocktranslate %}may move to the next question or previous questions.{% endblocktranslate %}{% else %}{% blocktranslate %}<strong>may not</strong> return to questions.{% endblocktranslate %}{% endif %}{% endif %}</li>
            {% if exam_info.hasTimeLimit %}
            <li>{% if exam_info.allowPause %}{% blocktranslate %}<strong>may</strong> pause the timer.{% endblocktranslate %}{% else %}{% blocktranslate %}<strong>may not</strong> pause the timer.{% endblocktranslate %}{% endif %}</li>
            {% endif %}
            <li>{% blocktranslate %}<strong>may</strong> leave the attempt and resume later.{% endblocktranslate %}</li>
        </ul>

        <table>
            <thead>
                <tr>
                    <th>{% translate "This will happen" %}</th>
                    <th>{% translate "When" %}</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>{% blocktranslate %}Students may attempt the exam{% endblocktranslate %}</td>
                    <td>
                        {% if resource.available_from == None %}
                            {% if resource.available_until == None %}{% translate "any time" %}{% else %}{% blocktranslate with available_until=resource.available_until %}until {{available_until}}{% endblocktranslate %}{% endif %}
                        {% else %}
                            {% if resource.available_until == None %}
                                {% blocktranslate with available_from=resource.available_from %}from {{available_from}}{% endblocktranslate %}
                            {% else %}
                                {% if resource.available_from < resource.available_until %}
                                    {% blocktranslate with available_from=resource.available_from available_until=resource.available_until %}between {{available_from}} and {{available_until}}{% endblocktranslate %}
                                {% else %}
                                    {% blocktranslate with available_from=resource.available_from available_until=resource.available_until %}before {{available_from}}, or after {{available_until}}{% endblocktranslate %}
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>{% translate "Students may review their attempts" %}</td>
                    <td>{% if resource.allow_review_from == None %}{% translate "immediately after finishing an attempt" %}{% else %}{% blocktranslate with allow_review_from=resource.allow_review_from %}from {{allow_review_from}}{% endblocktranslate %}{% endif %}</td>
                </tr>
                <tr>
                    <td>{% blocktranslate %}Each student's score will be reported back to the consumer{% endblocktranslate %}</td>
                    <td>{% if resource.report_mark_time == 'immediately' %}{% translate "as soon as it changes" %}{% elif resource.report_mark_time == 'oncompletion' %}{% translate "immediately after each attempt is completed" %}{% else %}{% translate "when the instructor requests it" %}{% endif %}</td>
                </tr>
            </tbody>
        </table>
    </section>
    {% endif %}

{% endblock management_content %}
